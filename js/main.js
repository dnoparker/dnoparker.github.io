import*as e from"three";import{MindARThree as t}from"mindar-face-three";import{createToneCircles as n,highlightAISuggestedTone as a,getCurrentTone as o,updateUISelection as i,tones as s}from"./tones.js";import{WedgeChart as r}from"./wedge.js";import{FaceObject as d}from"./faceObject.js";import{FaceDots as l}from"./faceDots.js";import{DisplayMode as c}from"./displayMode.js";import{storeToneChoices as u,storeRefusal as m}from"./firebase.js";import{debug as g,isClaude as h,CLAUDE_MODEL as p,GPT_MODEL as I,SYSTEM_PROMPT as E,AI_PROMPT as v,DISPLAY_SETTINGS as y,API_ENDPOINTS as b,FACE_ANCHOR_POINTS as T,CANVAS_SETTINGS as f,storeImages as L,showDebugUI as w}from"./config.js";let mindAR,renderer,scene,camera,faceObjects=[],facialAnchors=[],currentDisplayMode=c[y.DEFAULT_DISPLAY_MODE],minSwipeDistance=y.MIN_SWIPE_DISTANCE,videoElement=document.getElementById("webcam"),container=document.getElementById("container"),sendToAIButton=document.getElementById("send-to-ai"),getAverageColorsButton=document.getElementById("get-average-colors"),loadingAnimation=document.getElementById("loading-animation"),averageColorCircle=document.getElementById("average-color-circle"),saveButton=document.getElementById("save-data"),termsModal=document.getElementById("terms-modal"),acceptTermsButton=document.getElementById("accept-terms"),declineTermsButton=document.getElementById("decline-terms"),thankYouModal=document.getElementById("thank-you-modal"),userToneText=document.getElementById("user-tone-text"),aiToneText=document.getElementById("ai-tone-text"),startX=0,endX=0,modeButton=document.getElementById("mode-button"),capturedData={apiImage:null,fullResImage:null,userTone:null,aiTone:null,aiResponse:null},instructionPanel=document.getElementById("instruction-panel"),instructionText=document.getElementById("instruction-text"),instructionNext=document.getElementById("instruction-next"),isToneSelected=!1,isInPosition=!1,instructions=[{text:"Position your face inside the oval and hold still. Press next to continue.",action(){handleSendToAI(),instructionPanel.classList.add("hidden")}},{text:"Select your preferred tone from the options. Press next to continue.",async action(){instructionPanel.classList.add("hidden");try{await storeCapturedData(),userToneText.textContent=capturedData.userTone.toUpperCase()||"no tone",aiToneText.textContent=capturedData.aiTone.toUpperCase()||"no tone",thankYouModal.classList.remove("hidden"),capturedData={apiImage:null,fullResImage:null,userTone:null,aiTone:null,aiResponse:null},checkCapturedData(),sendToAIButton.disabled=!0,sendToAIButton.classList.add("button-disabled")}catch(e){console.error("Error saving data:",e)}}}],currentInstructionIndex=0,showInstruction=e=>{e<instructions.length?(instructionText.textContent=instructions[e].text,instructionPanel.classList.remove("hidden"),0===e?(instructionNext.disabled=!isInPosition,instructionNext.classList.toggle("button-disabled",!isInPosition)):1===e?(instructionNext.disabled=!isToneSelected,instructionNext.classList.toggle("button-disabled",!isToneSelected)):(instructionNext.disabled=!1,instructionNext.classList.remove("button-disabled"))):instructionPanel.classList.add("hidden")};instructionNext.addEventListener("click",()=>{if(currentInstructionIndex<instructions.length){oval.classList.add("hidden");let e=o();capturedData.userTone=e?.tone?.name||null,instructions[currentInstructionIndex].action&&instructions[currentInstructionIndex].action(),1===currentInstructionIndex&&(instructionPanel.classList.add("hidden"),userToneText.textContent=capturedData.userTone||"no tone",aiToneText.textContent=capturedData.aiTone||"no tone",thankYouModal.classList.remove("hidden"),sendToAIButton.disabled=!0,sendToAIButton.classList.add("button-disabled"))}});let rgbToHex=(e,t,n)=>`#${(16777216+(e<<16)+(t<<8)+n).toString(16).slice(1)}`,getScreenPosition=(t,n)=>{let a=new e.Vector3;t.getWorldPosition(a),a.project(n);let o=renderer.domElement,i=(a.x+1)/2*o.width,s=(-a.y+1)/2*o.height;return{x:Math.floor(i),y:Math.floor(s)}},scaleImage=(e,t,n)=>{let a=document.createElement("canvas");a.width=t,a.height=n;let o=a.getContext("2d");return o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(e,0,0,t,n),a};function createFaceObject(e,t,n){switch(currentDisplayMode){case c.WEDGE:return new r(e,t,n);case c.FACEDOTS:return new l(e,t,n);default:return new d(e,t,n)}}function addFaceObject(e){let t=createFaceObject(scene,camera,renderer);return t.setupEventListeners(),facialAnchors[e].group.add(t.group),faceObjects.push(t),t}function initializeWebcam(){navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoElement.srcObject=e}).catch(e=>{console.error("Error accessing webcam:",e)})}function initializeMindAR(){renderer=(mindAR=new t({container:container})).renderer,scene=mindAR.scene,camera=mindAR.camera}function setupFacialAnchors(){for(let e=0;e<468;e++){let t=mindAR.addAnchor(e);facialAnchors.push(t)}if(currentDisplayMode===c.WEDGE){let n=addFaceObject(T.WEDGE_ANCHOR);n.group.visible=!1}else T.DOT_ANCHORS.forEach(e=>{let t=addFaceObject(e);t.setDefaultTone(0)})}function setCameraPosition(){camera.position.z=y.CAMERA_POSITION_Z}let showLoading=()=>{loadingAnimation.classList.remove("loading-hidden");let e=document.querySelector(".loading-text");e||((e=document.createElement("div")).innerText="Analysing Face",e.className="loading-text",loadingAnimation.appendChild(e))},hideLoading=()=>{loadingAnimation.classList.add("loading-hidden")},handleGetAverageColors=e=>{getSampleFaceColors()},handleSwipeGesture=()=>{let e=endX-startX;Math.abs(e)>minSwipeDistance&&(e<0?faceObjects.forEach(e=>e.swipeLeft()):faceObjects.forEach(e=>e.swipeRight()))},handleTouchStart=e=>{startX=e.touches[0].clientX},handleTouchMove=e=>{endX=e.touches[0].clientX},handleTouchEnd=()=>{handleSwipeGesture()},handleMouseDown=e=>{startX=e.clientX},handleMouseMove=e=>{endX=e.clientX},handleMouseUp=()=>{handleSwipeGesture()},handleSendToAI=async()=>{sendToAIButton.disabled=!0,sendToAIButton.classList.add("button-disabled"),showLoading(),faceObjects.forEach(e=>{e instanceof r&&e.group.visible&&e.animateWedgesOut()});try{await captureScreenshot(),await new Promise(e=>setTimeout(e,2e3)),console.log("AI response received and processed")}catch(e){console.error("Error processing AI request:",e),displayText("Error processing AI request")}},toggleDisplayMode=e=>{if("wedge"===e)currentDisplayMode=c.WEDGE;else{if("dots"!==e)return;currentDisplayMode=c.FACEDOTS}if(faceObjects.forEach(e=>{let t=e.group.parent;t&&t.remove(e.group)}),faceObjects.length=0,currentDisplayMode===c.WEDGE){let t=addFaceObject(T.WEDGE_ANCHOR);t.animateSlicesToNewDistribution(0)}else for(let n of[0,100,200,300]){let a=addFaceObject(n);a.setDefaultTone(0)}i(0),highlightSelectedMode(e)},highlightSelectedMode=e=>{let t=document.querySelectorAll(".mode-option");t.forEach(t=>{t.getAttribute("data-mode")===e?t.classList.add("selected"):t.classList.remove("selected")})},handleKeyDown=e=>{"Space"===e.code&&(e.preventDefault(),toggleDisplayMode())};function setupEventListeners(){getAverageColorsButton.addEventListener("click",handleGetAverageColors),sendToAIButton.removeAttribute("disabled"),sendToAIButton.addEventListener("click",handleSendToAI),container.addEventListener("touchstart",handleTouchStart,!1),container.addEventListener("touchmove",handleTouchMove,!1),container.addEventListener("touchend",handleTouchEnd,!1),container.addEventListener("mousedown",handleMouseDown,!1),container.addEventListener("mousemove",handleMouseMove,!1),container.addEventListener("mouseup",handleMouseUp,!1),document.addEventListener("keydown",handleKeyDown);let e=document.getElementById("mode-button"),t=document.querySelector(".mode-dropdown-content");e.addEventListener("click",n=>{n.preventDefault();let a=e.classList.contains("menu-open");e.classList.toggle("menu-open"),a?t.classList.remove("visible"):setTimeout(()=>{t.classList.add("visible")},150)}),document.querySelectorAll(".mode-option").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let t=e.currentTarget.getAttribute("data-mode");toggleDisplayMode(t)})}),document.addEventListener("click",n=>{n.target.closest(".mode-dropdown")||(e.classList.remove("menu-open"),t.classList.remove("visible"))}),highlightSelectedMode(currentDisplayMode===c.WEDGE?"wedge":"dots")}modeButton.addEventListener("click",()=>{toggleDisplayMode()});let startAR=async()=>{await mindAR.start();let t=document.getElementById("oval");renderer.setAnimationLoop(()=>{renderer.render(scene,camera);let n=facialAnchors[19];if(n){let a=new e.Vector3;n.group.getWorldPosition(a);let o=a.x-camera.position.x,i=Math.abs(o);isInPosition=i<3,t.classList.toggle("in-position",isInPosition),0===currentInstructionIndex&&(instructionNext.disabled=!isInPosition,instructionNext.classList.toggle("button-disabled",!isInPosition))}faceObjects.forEach(e=>{e.update()})})},uploadImageToServer=async e=>{try{let t=await fetch(e),n=await t.blob(),a=`capture_${Date.now()}.png`,o=`https://hotknife.co.uk/imageuploader_1/uploads/${a}`;console.log("Image URL:",o);let i=new FormData;return i.append("image",n,a),fetch("https://hotknife.co.uk/imageuploader_1/upload.php",{method:"POST",body:i}).catch(e=>console.error("PHP upload error:",e)),console.log("Generated image URL:",o),o}catch(s){return console.error("Error preparing image:",s),null}},captureScreenshot=async()=>{let e=document.createElement("canvas");e.width=renderer.domElement.width,e.height=renderer.domElement.height;let t=e.getContext("2d");t.translate(e.width,0),t.scale(-1,1),t.drawImage(videoElement,0,0,e.width,e.height),t.setTransform(1,0,0,1,0,0);let n=getScreenPosition(facialAnchors[10].group,camera),a=getScreenPosition(facialAnchors[152].group,camera),o=a.y-n.y,i=.2*o,s=Math.max(0,n.x-o/2),r=Math.max(0,n.y-i),d=Math.min(o,e.width-s),l=Math.min(o+2*i,e.height-r),c=document.createElement("canvas");c.width=d,c.height=l;let u=c.getContext("2d");u.drawImage(e,s,r,d,l,0,0,d,l),renderer.render(scene,camera);let m=new Image;m.src=renderer.domElement.toDataURL("image/png"),m.onload=async()=>{let t=e.toDataURL("image/png"),n=scaleImage(c,f.API_IMAGE_SIZE,f.API_IMAGE_SIZE),a=n.toDataURL("image/png"),o=a.split(",")[1];capturedData.apiImage=a,capturedData.fullResImage=t,checkCapturedData();let i;if(g)i="Based on the image swatch provided, this person's skin tone mostly closely resembles: Raven",await new Promise(e=>setTimeout(e,3e3));else{let s=new Image;s.crossOrigin="Anonymous";try{await new Promise((e,t)=>{s.onload=e,s.onerror=t,s.src="swatch.png"});let r=document.createElement("canvas");r.width=s.width,r.height=s.height;let d=r.getContext("2d");d.drawImage(s,0,0);let l=scaleImage(r,f.API_IMAGE_SIZE,f.API_IMAGE_SIZE),u=l.toDataURL("image/png").split(",")[1];i=await sendToVisionAPIMulti(o,u)}catch(m){console.error("Error processing swatch image:",m);return}}i?await displayTextWithImage(i,t):await displayTextWithImage("No response from Vision API",t)}},getSampleFaceColors=async()=>{let t=document.createElement("canvas");t.width=renderer.domElement.width,t.height=renderer.domElement.height;let n=t.getContext("2d");n.translate(t.width,0),n.scale(-1,1),n.drawImage(videoElement,0,0,t.width,t.height),n.setTransform(1,0,0,1,0,0);let a=n.getImageData(0,0,t.width,t.height),o=0,i=0,s=0,r=0;if(facialAnchors.forEach(n=>{let{x:d,y:l}=getScreenPosition(n.group,camera);if(d>=0&&d<t.width&&l>=0&&l<t.height){let c=(l*t.width+d)*4,u=a.data[c],m=a.data[c+1],g=a.data[c+2],h=rgbToHex(u,m,g),p=n.group.children.find(t=>t instanceof e.Mesh);p&&p.material.color.set(h),o+=u,i+=m,s+=g,r++}}),r>0){let d=Math.round(o/r),l=Math.round(i/r),c=Math.round(s/r),u=rgbToHex(d,l,c);updateAverageColorCircle(u)}},sendToVisionAPIMulti=async(e,t)=>{try{console.log("Sending images to API:",{image1Length:e.length,image2Length:t.length});let n=h?b.CLAUDE_VISION:b.VISION_API_MULTI,a=h?p:I,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({base64Image1:e,base64Image2:t,prompt:v,model:a,systemPrompt:E})});if(!o.ok){let i=await o.text();throw console.error("API Error:",i),Error(`HTTP error! status: ${o.status}`)}let s=await o.json();return console.log("API Response:",s),s.content}catch(r){return console.error("Error sending images to Vision API:",r),null}},displayText=e=>{hideLoading();let t=document.querySelectorAll(".displayed-text");t.forEach(e=>e.remove());let n=document.createElement("div");n.innerText=e,n.className="displayed-text";let a=document.createElement("span");a.innerText=" X",a.className="dismiss-btn",a.onclick=()=>{n.remove(),sendToAIButton.disabled=!1,sendToAIButton.classList.remove("button-disabled")},n.appendChild(a),document.body.appendChild(n)},storeCapturedData=async()=>{try{let e=null;return L&&(e=await uploadImageToServer(capturedData.apiImage),console.log("Image upload result:",e)),console.log("About to store in Firebase:",{userTone:capturedData.userTone,aiTone:capturedData.aiTone,uploadedImageUrl:e,aiResponse:capturedData.aiResponse}),await u(capturedData.userTone,capturedData.aiTone,e,capturedData.aiResponse),console.log("Successfully stored in Firebase with image URL:",e),e}catch(t){return console.error("Error storing captured data:",t),null}},displayTextWithImage=async(e,t)=>{hideLoading();let n=extractToneName(e),i=o();capturedData.userTone=i?.tone?.name||null,capturedData.aiTone=n,capturedData.aiResponse=e,checkCapturedData();let d=s.find(e=>e.name.toUpperCase()===n.toUpperCase()),l=d?d.hex:"#FFFFFF",c=document.getElementById("result-modal"),u=document.getElementById("result-image"),g=document.getElementById("result-text"),h=document.getElementById("result-color-line"),p=document.getElementById("result-tone-name"),I=document.getElementById("submit-result"),E=document.getElementById("retry-result");if(u.src=t,n&&-1===e.toLowerCase().indexOf("sorry"))g.textContent=`The fabric most suited for this person is ${n}`,I.style.display="block",E.style.display="none";else if(g.textContent="Sorry, something went wrong, please retry",I.style.display="none",E.style.display="block",capturedData.apiImage){let v=null;L&&(v=await uploadImageToServer(capturedData.apiImage)),await m(v,e)}h.style.backgroundColor=l,p.textContent=n||"",c.classList.remove("hidden"),I.onclick=()=>{c.classList.add("hidden"),document.querySelector(".mode-dropdown").classList.add("visible"),document.getElementById("tone-circles").classList.add("visible"),faceObjects.forEach(e=>{e.group.visible=!0}),showInstruction(currentInstructionIndex=1)},E.onclick=()=>{oval.classList.remove("hidden"),c.classList.add("hidden"),sendToAIButton.disabled=!1,sendToAIButton.classList.remove("button-disabled"),faceObjects.forEach(e=>{e.group.visible=!1}),faceObjects.forEach(e=>{e instanceof r&&e.animateWedgesIn()}),showInstruction(currentInstructionIndex=0)},a(n),checkAndLogTone(e)},extractToneName=e=>{let t=s.map(e=>e.name.toLowerCase()),n=t.find(t=>e.toLowerCase().includes(t.toLowerCase()));return n?n.charAt(0).toUpperCase()+n.slice(1):""},updateAverageColorCircle=e=>{averageColorCircle.style.backgroundColor=e},checkAndLogTone=e=>{let t=extractToneName(e);t&&(a(t),console.log("AI suggested tone:",t))},checkCapturedData=()=>{let e=null!==capturedData.apiImage&&null!==capturedData.fullResImage&&null!==capturedData.userTone&&null!==capturedData.aiTone;saveButton.disabled=!e,e?saveButton.classList.remove("button-disabled"):saveButton.classList.add("button-disabled")};saveButton.addEventListener("click",async()=>{saveButton.disabled=!0,saveButton.classList.add("button-disabled");try{await storeCapturedData(),capturedData={apiImage:null,fullResImage:null,userTone:null,aiTone:null,aiResponse:null},checkCapturedData()}catch(e){console.error("Error saving data:",e),saveButton.disabled=!1,saveButton.classList.remove("button-disabled")}});let initializeDebugUI=()=>{w&&(document.querySelectorAll(".debug-ui").forEach(e=>{e.classList.add("visible")}),document.querySelector(".button-row").classList.add("visible"))};document.addEventListener("DOMContentLoaded",()=>{termsModal.classList.remove("hidden"),acceptTermsButton.addEventListener("click",()=>{termsModal.classList.add("hidden"),initializeDebugUI(),initializeWebcam(),initializeMindAR(),setupFacialAnchors(),setCameraPosition(),setupEventListeners(),n(),startAR(),document.querySelector(".mode-dropdown").classList.remove("visible"),document.getElementById("tone-circles").classList.remove("visible"),showInstruction(currentInstructionIndex=0);let e=document.getElementById("oval-instruction-modal");e.classList.remove("hidden"),document.getElementById("understand-oval").addEventListener("click",()=>{e.classList.add("hidden")})}),declineTermsButton.addEventListener("click",()=>{alert("You must accept the terms to use this application.")}),document.getElementById("start-over").addEventListener("click",()=>{window.location.reload()})}),window.updateNextButtonState=e=>{isToneSelected=e,1===currentInstructionIndex&&(instructionNext.disabled=!e,instructionNext.classList.toggle("button-disabled",!e))};let handleToneSelection=e=>{updateNextButtonState(!0)},handleToneDeselection=()=>{updateNextButtonState(!1)};